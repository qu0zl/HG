<!doctype html>
<html lang="us">
<!--
   Copyright 2016 Greg Farrell

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<head>
	<meta charset="utf-8">
		<title>S&W Hireling Generator</title>
			<link href="jquery-ui.css" rel="stylesheet">
			<style>
.class_stats {
	background-color:rgb(220,220,220);
	margin:5px;
	display:inline-block;
}
.class_stat {
	display:inline-block;
}
.weight_input {
	display:inline-block;
}
.stat_header {
	display:block;
}
.class_title {
	font-weight:bold;
	font-size:larger;
	margin:5px;
	width:5em;
	display:inline-block;
	flex-flow: column;
}
#name_credits {
	font-weight:light;
	font-size:smaller;
	margin-top:3em;
}
#results {
	border-style:solid;
}
.character {
	display:flex;
	flex-flow: row;
	margin:5px;
}
.character_name {
	display:flex;
	flex-flow: column;
	margin:5px;
	width:12em;
}
.character_stats {
	display:flex;
	flex-flow: row;
	margin:5px;
}
.character_stat {
	display:flex;
	margin-left:5px;
	margin-right:5px;
	width:2em;
}

.character_pos_class {
	display:flex;
	margin:5px;
	width:20em;
}
.character_class {
	display:flex;
	margin:5px;
	width:5em;
}
			</style>

</head>
<body>

<h1>Welcome to the Swords and Wizardry hireling generator.</h1>

<!-- Button -->
<button id="generate">Generate a hireling</button>
<form style="margin-top: 1em;">
	<div id="radioset">
	<input type="radio" value=1 id="radio1" name="radio"><label for="radio1">1</label>
	<input type="radio" value="D6" id="radio2" name="radio" checked="checked"><label for="radio2">D6</label>
	<input type="radio" value=10 id="radio3" name="radio"><label for="radio3">10</label>
	<input type="radio" value=20 id="radio4" name="radio"><label for="radio4">20</label>
	</div>
</form>

<div id='min_stats_div'>
</div>

<DIV id='results'>
	<DIV class="character">
		<DIV class="character_name">Name</DIV>
		<DIV class="character_stats">
			<DIV class="character_stat">Str</DIV>
			<DIV class="character_stat">Dex</DIV>
			<DIV class="character_stat">Con</DIV>
			<DIV class="character_stat">Int</DIV>
			<DIV class="character_stat">Wis</DIV>
			<DIV class="character_stat">Cha</DIV>
		</DIV>
		<DIV class="character_class">Class</DIV>
		<DIV class='character_pos_class'>Possible Classes</DIV>
	</DIV>
</div>
<DIV id='credits'>
	<DIV id='name_credits'></DIV>
</DIV>


<script src="jquery.js"></script>
<script src="jquery-ui.js"></script>
<script src="name-gen.js"></script>
<script>

NUM_STATS = 6;
STAT_STR = 0;
STAT_DEX = 1;
STAT_CON = 2;
STAT_INT = 3;
STAT_WIS = 4;
STAT_CHA = 5;

STAT_SHORT_NAMES = ["Str", "Dex", "Con", "Int", "Wis", "Cha"];

// selects to enable/disable particular classes
// option to ignore/require minimum stat values
// selectors to change min stat requirements
// selectors for stat roll, roll x, drop y

var test_distribution = 0;
var distribution = [];

/* with these values and a 4D6-drop-lowest approach I got a distribution for 200,000 runs of:
   Total:200000  Assassin:11.091%, Cleric:15.0205%, Druid:13.6165%, Dwarf:8.429%, Elf:9.58%, Fighter:9.4335%, Magic User:9.8325%, Monk:1.6865%, Paladin:4.82%, Ranger:5.0525%, Thief:11.437999999999999%, 

   With these values and a 3D6 approach,  I got a distributions for two runs of 200,000 each of:
   Total:200000  Assassin:3.2515%, Cleric:22.0805%, Druid:4.707%, Dwarf:6.8145%, Elf:4.9635%, Fighter:16.9325%, Magic User:18.685%, Monk:0.21250000000000002%, Paladin:1.6575%, Ranger:0.9755%, Thief:19.72%, 
   Total:200000  Assassin:3.1919999999999997%, Cleric:22.331500000000002%, Druid:4.74%, Dwarf:6.8715%, Elf:5.0305%, Fighter:16.827%, Magic User:18.390500000000003%, Monk:0.2075%, Paladin:1.6925%, Ranger:0.985%, Thief:19.732%, 
   */
var classes = [
	{
		name: 'Assassin',
		stats:[12,12,0,12,0,0],
		weighting:10
	},
	{
		name: 'Cleric',
		stats:[0,0,0,0,13,0], // not according to book, but min Wis 13 seems sensible for auto-gen
		weighting:1
	},
	{
		name: 'Druid',
		stats:[0,0,0,0,12,14],
		weighting:20
	},
	{
		name: 'Dwarf',
		stats:[13,0,10,0,0,0],
		weighting:1
	},
	{
		name: 'Elf',
		stats:[0,12,0,13,0,0],
		weighting:5
	},
	{
		name: 'Fighter',
		stats:[13,0,0,0,0,0],
		weighting:1
	},
	{
		name: 'Magic User',
		stats:[0,0,0,13,0,0], // not according to book, but min Int 13 seems sensible for auto-gen
		weighting:1
	},
	{
		name: 'Monk',
		stats:[12,15,0,0,15,0],
		weighting:20
	},
	{
		name: 'Paladin',
		stats:[0,0,0,0,0,17],
		weighting:100
	},
	{
		name: 'Ranger',
		stats:[0,0,15,12,12,0],
		weighting:20
	},
	{
		name: 'Thief',
		stats:[0,13,0,0,0,0],
		weighting:1
	}
];

function randomRange(min,max) {
	var randomNumber = Math.floor(Math.random()*(max-min+1)+min);
	return randomNumber;
}

function possible_classes(stats) {
	var i = 0, j = 0;
	var return_array = [];
	for (i=0; i<classes.length; i++) {
		if ("stats" in classes[i]) {
			var allowed = true;
			for (j=0; j<classes[i].stats.length; j++) {
				if (classes[i].stats[j] > stats[j])
					allowed = false;
			}
			if (allowed)
				return_array.push(classes[i]);
		}
	}
	return return_array;
}

function d6() {
	return randomRange(1,6);
}

function getStat(dieCount, dropCount) {
	var i = 0 ;
	var die = [];
	var total = 0;
	for (i=0; i<dieCount; i++)
		die[i] = d6();
	if (dropCount >= dieCount) // minimum 1 dice return
		dropCount = dieCount - 1;
	if (dropCount > 0) {
		die.sort(function(a,b){return a-b;});
		for(i=0; i<dropCount; i++) {
			die.shift();
		}
	}
	for (i=0; i<die.length; i++)
		total += die[i];

	return total;
}

function renderCharacterStats(stats)
{
	var text = '<DIV class="character_stats">';
	var i;
	for (i=0; i<NUM_STATS; i++) {
		text += "<DIV class='character_stat'>" + stats[i] + "</DIV>";
	}

	text += '</DIV>';
	return text;
}

function chooseClass(possible_classes, character_stats)
{
	var total_weight = 0;
	var i;
	var choice = 0;
	/* If we meet any classes minimum stat values then we will choose one of those classes
	   Otherwise will we pick between thief, fight, cleric and magic user depending on our highest of their 4 prime stats */
	if (possible_classes.length > 0) {
		for (i=0; i<possible_classes.length; i++)
			total_weight += possible_classes[i].weighting;
		choice = randomRange(0, total_weight);
		for (i=0, total_weight=0; i < possible_classes.length; i++) {
			total_weight += possible_classes[i].weighting;
			if (total_weight >= choice)
				break;
		}
		if (test_distribution)
			distribution.push(possible_classes[i].name);
		return possible_classes[i].name;
	} else {
		var i=0, choice;
		var choices=[ {stat:character_stats[STAT_STR], 'class':'Fighter'},
						{stat:character_stats[STAT_WIS], 'class':'Cleric'},
						{stat:character_stats[STAT_INT], 'class':'Magic User'},
						{stat:character_stats[STAT_DEX], 'class':'Thief'} ];
		choices.sort( function(a,b){ return b.stat - a.stat; });
		// randomly choose between all with exact same prime stat
		for (i=0; i<(choices.length-1); i++) {
			if (choices[i].stat != choices[i+1].stat)
				break;
		}
		choice = randomRange(0,i);
		if (test_distribution)
			distribution.push(choices[choice].class);
		return(choices[choice].class);
	}
}

function renderCharacterClass(character)
{
	var possible_classes = "";
	var i;
	for (i=0; i<character.class.length; i++) {
		if (i>0)
			possible_classes += ", ";
		possible_classes += character.class[i].name;
	}
	var text = '<DIV class="character_class">';
	text += chooseClass(character.class, character.stats) + "</DIV><DIV class='character_pos_class'>" + (character.class.length > 1 ? "("+possible_classes+")" : "") + "</DIV>";

	return text;
}

/* This does not need to be simple male/female.
   It receives a 0=male, 1=female argument but it can randomly decide that a certain percentage of each of those are
   not binary. */
function render_gender(gender) {
	var TS = randomRange(0,99);
	if (TS==0)
		return " (TS)";
	else if (gender == 0)
		return " (M)";
	else return " (F)";
}

function appendResult(character) {
	var text='<DIV class="character"><DIV class="character_name">';
	text += name_gen(character.gender) + render_gender(character.gender) + '</DIV>';
	text += renderCharacterStats(character.stats);
	text += renderCharacterClass(character);
	text += '</DIV>';
	//if (!test_distribution)
		$('#results').append(text);
}

function calc_dist() {
	var total = distribution.length;
	var current = 0
	var i = 0;
	var text = "Total:" +total+"  ";
	distribution.sort();
	for (i=1, current=1; i<distribution.length; i++) {
		if (distribution[i] == distribution[i-1])
			current++;
		else {
			text += distribution[i-1] + ":" + (current/total)*100 + "%, ";
			current = 1;
		}
	}
	if (i == distribution.length)
		text += distribution[i-1] + ":" + (current/total)*100 + "%, ";

	// greg do last one also...
	//console.log(JSON.stringify(distribution));
	console.log(text);
}

function generate() {
	var stats = [];
	var character = {};
	var i, j;
	var radio = $("#radioset input[type='radio']:checked");
	var value = 1;
	if (radio.length > 0) {
		value = radio.val();
	}
	if (value == "D6") {
		value = randomRange(1,6);
	}
	if (test_distribution)
		value *= 10000;
	for (j=0; j<value; j++) {
		character.gender = randomRange(0,1);
		for (i=0; i<NUM_STATS; i++){
			stats[i] = getStat(4,1);
		}
		character['stats'] = stats;
		character['class'] = possible_classes(stats);
		appendResult(character);
	}
	if (test_distribution)
		calc_dist();

}

$('#generate').button();

$('#generate').click( function() {
	generate();
	} );

function change_min_stat(event) {
	var class_number = $(event.target).data('class');
	var stat_number = $(event.target).data('stat');
	classes[class_number].stats[stat_number] = event.target.value;
}

function change_weighting(event) {
	var class_number = $(event.target).data('class');
	classes[class_number].weighting = parseInt(event.target.value);
}

function onReady()
{
	var i, j, stat;
	var stat_div = $('#min_stats_div');
	for (i=0; i<classes.length; i++){
		var text = "<DIV class='class_stats' name='min_stat_"+classes[i].name+"'>";
		text += "<DIV class='class_title'>"+classes[i].name+"</DIV>";

		for (stat=0; stat<6; stat++) {
			text += "<DIV class='class_stat' name='min_stat_"+classes[i].name+'_'+stat+"'>";
			text += '<span class=stat_header>'+STAT_SHORT_NAMES[stat]+'</span>';
			text += '<select class="min_stat_select" data-class='+i+' data-stat='+stat+'>';
			for (j=0; j<=18; j++) {
				if (j!=1 && j!=2)
					if (classes[i].stats[stat] == j)
						text+='<option selected="selected">'+j+'</option>';
					else
						text+='<option>'+j+'</option>';
			}
			text+= '</select></DIV>';
		}
		text += "<DIV class='class_stat'><span class=stat_header>Weighting</span><input class='weight_input' size=3 data-class="+i+" value="+classes[i].weighting+"></input></DIV>";
		text += '</DIV>';
	    stat_div.append(text);

	}
	$('#name_credits').html(name_credits());
	$(".min_stat_select").change(change_min_stat);
	$(".weight_input").change(change_weighting);
/*
			  change: change_min_stat
			  }); */
}
$(document).ready(onReady);

</script>
</body>

