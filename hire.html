<!doctype html>
<html lang="us">
<!--
   Copyright 2016 Greg Farrell

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<head>
	<meta charset="utf-8">
		<title>Complete Hireling generator</title>
			<link href="jquery-ui.css" rel="stylesheet">
			<style>
.top_button {
	display:inline-block;
	border-style:ridge;
	border-width:thin;
	margin:5px;
}
.title {
	font-style:x-large;
}
.subtitle {
	font-style:italic;
	font-size:small;
}
.class_stats {
	background-color:rgb(220,220,220);
	margin:5px;
	display:inline-block;
}
.class_stat {
	display:inline-block;
}
.weight_input {
	display:inline-block;
}
.stat_header {
	display:block;
}
.class_title {
	font-weight:bold;
	font-size:larger;
	margin:5px;
	width:5em;
	display:inline-block;
	flex-flow: column;
}
.credits {
	font-weight:light;
	font-size:smaller;
	margin-top:3em;
}
#results {
	border-style:solid;
}
.character {
	display:flex;
	flex-flow: row;
	margin:5px;
    border-bottom-style:dotted;
    border-bottom-width:thin;
}
.character_name {
	display:flex;
	flex-flow: column;
	margin:5px;
	width:9em;
    min-width:9em;
}
.character_stats {
	display:flex;
	flex-flow: row;
	margin:5px;
}
.character_stat {
	display:flex;
	margin-left:5px;
	margin-right:5px;
	width:2em;
}

.character_pos_class {
	display:flex;
	margin:5px;
	width:10em;
    min-width:10em;
}
.character_class {
	display:flex;
	margin:5px;
	width:4em;
    min-width:4em;
}
.character_equipment {
	display:flex;
	margin:5px;
	width:9em;
    min-width:9em;
}
.character_trait {
	display:flex;
	margin:5px;
}
			</style>

</head>
<body>

<h1 class='title'>Welcome to the Complete Hireling generator.</h1>
<h2 class='subtitle'>A hireling generator designed with Swords & Wizardry Complete in mind, but also suitable for other Old School RPGs</h2>

<!-- Button -->
<button id="generate">Generate D6 hirelings</button>
<DIV class="top_button_group">
<DIV class="top_button">
	<div id="radioset">Number to generate:
	<input type="radio" value=1 id="radio1" name="radio"><label for="radio1">1</label>
	<input type="radio" value="D6" id="radio2" name="radio" checked="checked"><label for="radio2">D6</label>
	<input type="radio" value=10 id="radio3" name="radio"><label for="radio3">10</label>
	<input type="radio" value=20 id="radio4" name="radio"><label for="radio4">20</label>
	</div>
</DIV>
<DIV class="top_button">
	<DIV id="statset">Stat generation method:
	<input type="radio" value=1 id="statgen1" name="statgen"><label for="statgen1">3D6</label>
	<input type="radio" value=2 id="statgen2" name="statgen" checked="checked"><label for="statgen2">4D6 drop lowest</label>
	</DIV>
</DIV>
</DIV>

<div id='min_stats_div'>
</div>

<DIV id='results'>
	<DIV class="character">
		<DIV class="character_name">Name</DIV>
		<DIV class="character_stats">
			<DIV class="character_stat">Str</DIV>
			<DIV class="character_stat">Dex</DIV>
			<DIV class="character_stat">Con</DIV>
			<DIV class="character_stat">Int</DIV>
			<DIV class="character_stat">Wis</DIV>
			<DIV class="character_stat">Cha</DIV>
		</DIV>
		<DIV class="character_class">Class</DIV>
		<DIV class='character_pos_class'>Possible Classes</DIV>
	</DIV>
</div>
<DIV id='credits' class='credits'>
	<DIV id='name_credits' class='credit'></DIV>
	<DIV id='SW_Credits' class='credit'>This site is not affiliated with Matthew J. Finch or Mythmere Gamesâ„¢. Swords & Wizardry, S&W, and Mythmere Games are the trademarks of Matthew J. Finch.</DIV>
</DIV>


<script src="jquery.js"></script>
<script src="jquery-ui.js"></script>
<script src="name-gen.js"></script>
<script src="equip.js"></script>
<script src="traits.js"></script>
<script>

NUM_STATS = 6;
STAT_STR = 0;
STAT_DEX = 1;
STAT_CON = 2;
STAT_INT = 3;
STAT_WIS = 4;
STAT_CHA = 5;

STAT_SHORT_NAMES = ["Str", "Dex", "Con", "Int", "Wis", "Cha"];

// selects to enable/disable particular classes
// option to ignore/require minimum stat values

var test_distribution = 0;
var distribution = [];

/* with these values and a 4D6-drop-lowest approach I got a distribution for 400,000 runs of:
	Total:400000  Assassin:12.18625%, Cleric:16.183500000000002%, Druid:6.64825%, Dwarf:6.097%, Elf:6.249%, Fighter:17.6815%, Magic User:10.50475%, Monk:1.8145000000000002%, Paladin:5.202500000000001%, Ranger:5.725750000000001%, Thief:11.706999999999999%, 
   */

/* By the default weapon chooser, we will never choose more than 2 weapons from a set (weapon or ranged)
   for a single character.
   So you may put 100% options as the 3rd entry for a set, and it will be guaranteed to be choosen if
   they do not already have 2 weapons. Thus you can put less likely options first and still guarantee a
   weapon even if the rolls are unlucky */
var classes = [
	{
		name: 'Assassin',
		stats:[12,12,0,12,0,0],
		weighting:10,
		armour:"leather",
		weapon:[[100, "light"], [40, "light"], [25, "heavy"]],
		ranged:[[40, "light ranged"]],
		shield:35
	},
	{
		name: 'Cleric',
		stats:[0,0,0,0,13,0], // not according to book, but min Wis 13 seems sensible for auto-gen
		weighting:1,
		armour:"heavy",
		weapon:[[100,"cleric"]],
		ranged:[[25, "cleric ranged"]],
		shield:40
	},
	{
		name: 'Druid',
		stats:[0,0,0,0,12,14],
		weighting:3,
		armour:"leather",
		weapon:[[100, "druid"]],
		ranged:[[40, "cleric ranged"]],
		shield:40
	},
	{
		name: 'Dwarf',
		stats:[13,0,10,0,0,0],
		weighting:1,
		weapon:[[100, "heavy"], [15, "light"]],
		ranged:[[10, "ranged"]],
		armour:"all",
		shield:40
	},
	{
		name: 'Elf',
		stats:[0,12,0,13,0,0],
		weighting:2,
		weapon:[ [40, "heavy"], [35, "light"], [100, "light"]],
		ranged:[[50, "ranged"]],
		armour:"all",
		shield:30
	},
	{
		name: 'Fighter',
		stats:[13,0,0,0,0,0],
		weighting:3,
		weapon:[[60, "heavy"], [25, "light"], [100, "light"]],
		ranged:[[50, "ranged"]],
		armour:"all",
		shield:50
	},
	{
		name: 'Magic User',
		stats:[0,0,0,13,0,0], // not according to book, but min Int 13 seems sensible for auto-gen
		weighting:1,
		weapon:[[100, "magic user"]],
		ranged:[[60, "magic user ranged"]]
	},
	{
		name: 'Monk',
		stats:[12,15,0,0,15,0],
		weighting:20,
		weapon:[[100, "monk"], [10, "monk"]],
		ranged:[[10, "ranged"]]
	},
	{
		name: 'Paladin',
		stats:[0,0,0,0,0,17],
		weighting:100,
		weapon:[[30, "light"], [30, "light"], [100, "heavy"]],
		ranged:[[30, "ranged"]],
		armour:"all",
		shield:70
	},
	{
		name: 'Ranger',
		stats:[0,0,15,12,12,0],
		weighting:20,
		weapon:[[60, "light"], [40, "light"], [100, "heavy"]],
		ranged:[[60, "ranged"]],
		armour:"all",
		shield:40
	},
	{
		name: 'Thief',
		stats:[0,13,0,0,0,0],
		weighting:1,
		weapon:[[45, "dagger"], [10, "heavy"], [100, "light"]],
		ranged:[[40, "light ranged"]],
		armour:"leather"
	}
];

function class_by_name(name) {
	classes
	var i = 0;
	for (i=0; i<classes.length; i++)
		if (classes[i].name == name)
			return classes[i];
	return undefined;
}

// set up some global variables pointing to the default fallback classes, which will be used in class selection repeatedly
Thief = class_by_name('Thief');
Fighter = class_by_name('Fighter');
Magic_User = class_by_name('Magic User');
Cleric = class_by_name('Cleric');

function randomRange(min,max) {
	var randomNumber = Math.floor(Math.random()*(max-min+1)+min);
	return randomNumber;
}

function possible_classes(stats) {
	var i = 0, j = 0;
	var return_array = [];
	for (i=0; i<classes.length; i++) {
		if ("stats" in classes[i]) {
			var allowed = true;
			for (j=0; j<classes[i].stats.length; j++) {
				if (classes[i].stats[j] > stats[j])
					allowed = false;
			}
			if (allowed)
				return_array.push(classes[i]);
		}
	}
	return return_array;
}

function d6() {
	return randomRange(1,6);
}

function getStat(dieCount, dropCount) {
	var i = 0 ;
	var die = [];
	var total = 0;
	for (i=0; i<dieCount; i++)
		die[i] = d6();
	if (dropCount >= dieCount) // minimum 1 dice return
		dropCount = dieCount - 1;
	if (dropCount > 0) {
		die.sort(function(a,b){return a-b;});
		for(i=0; i<dropCount; i++) {
			die.shift();
		}
	}
	for (i=0; i<die.length; i++)
		total += die[i];

	return total;
}

function renderCharacterStats(stats)
{
	var text = '<DIV class="character_stats">';
	var i;
	for (i=0; i<NUM_STATS; i++) {
		text += "<DIV class='character_stat'>" + stats[i] + "</DIV>";
	}

	text += '</DIV>';
	return text;
}

function chooseClass(possible_classes, character_stats)
{
	var total_weight = 0;
	var i;
	var choice = 0;
	/* If we meet any classes minimum stat values then we will choose one of those classes
	   Otherwise will we pick between thief, fight, cleric and magic user depending on our highest of their 4 prime stats */
	if (possible_classes.length > 0) {
		for (i=0; i<possible_classes.length; i++)
			total_weight += possible_classes[i].weighting;
		choice = randomRange(0, total_weight);
		for (i=0, total_weight=0; i < possible_classes.length; i++) {
			total_weight += possible_classes[i].weighting;
			if (total_weight >= choice)
				break;
		}
		if (test_distribution)
			distribution.push(possible_classes[i].name);
		return possible_classes[i];
	} else {
		var i=0, choice;
		var choices=[ {stat:character_stats[STAT_STR], 'class':Fighter},
						{stat:character_stats[STAT_WIS], 'class':Cleric},
						{stat:character_stats[STAT_INT], 'class':Magic_User},
						{stat:character_stats[STAT_DEX], 'class':Thief} ];
		choices.sort( function(a,b){ return b.stat - a.stat; });
		// randomly choose between all with exact same prime stat
		for (i=0; i<(choices.length-1); i++) {
			if (choices[i].stat != choices[i+1].stat)
				break;
		}
		choice = randomRange(0,i);
		if (test_distribution)
			distribution.push(choices[choice].class.name);
		return(choices[choice].class);
	}
}

function render_armour(character_class) {
	var armour_group = character_class.armour;
	var text = ", ";
	if (armour_group == undefined)
		return "";
	text += get_armour(armour_group).name;
	var chance = 0;
	if (character_class.shield){
		if (randomRange(1,100) <= character_class.shield)
			text+=", shield";
	}
		
	return text;

}

function render_trait(character_class) {
	var text = "<DIV class='character_trait'>" + get_trait(character_class) + "</DIV>";
	return text;
}

function render_equipment(character_class) {
	var i = 0;
	var weapons = get_weapons(character_class.weapon);
	var ranged = get_weapons(character_class.ranged);
	for (i=0; i<ranged.length; i++)
		weapons.push(ranged[i]);

	text = "<DIV class='character_equipment'>";
	for (i=0; i<weapons.length; i++) {
		if (i>0)
			text += ', ';
		text += weapons[i];
	}

	text += render_armour(character_class);

	text += "</DIV>";
	return text;
}

function renderCharacterClass(character)
{
	var possible_classes = "";
	var i;
	for (i=0; i<character.class.length; i++) {
		if (i>0)
			possible_classes += ", ";
		possible_classes += character.class[i].name;
	}
	var text = '<DIV class="character_class">';
	var chosen_class = chooseClass(character.class, character.stats);
	text += chosen_class.name + "</DIV><DIV class='character_pos_class'>" + (character.class.length > 1 ? "("+possible_classes+")" : "") + "</DIV>";

	text += render_equipment(chosen_class);
	text += render_trait(chosen_class);
	return text;
}

/* This does not need to be simple male/female.
   It receives a 0=male, 1=female argument but it can randomly decide that a certain percentage of each of those are
   not binary. */
function render_gender(gender) {
	var TS = randomRange(0,99);
	if (TS==0)
		return " (TS)";
	else if (gender == 0)
		return " (M)";
	else return " (F)";
}

function appendResult(character) {
	var text='<DIV class="character"><DIV class="character_name">';
	text += name_gen(character.gender) + render_gender(character.gender) + '</DIV>';
	text += renderCharacterStats(character.stats);
	text += renderCharacterClass(character);
	text += '</DIV>';
	//if (!test_distribution)
		$('#results').append(text);
}

function calc_dist() {
	var total = distribution.length;
	var current = 0
	var i = 0;
	var text = "Total:" +total+"  ";
	distribution.sort();
	for (i=1, current=1; i<distribution.length; i++) {
		if (distribution[i] == distribution[i-1])
			current++;
		else {
			text += distribution[i-1] + ":" + (current/total)*100 + "%, ";
			current = 1;
		}
	}
	if (i == distribution.length)
		text += distribution[i-1] + ":" + (current/total)*100 + "%, ";

	console.log(text);
}

function generate() {
	var stats = [];
	var character = {};
	var i, j;
	var radio = $("#radioset input[type='radio']:checked");
	var stat_method_radio = $("#statset input[type='radio']:checked");
	var num_die = 4;
	var drop_die = 1;
	if ( stat_method_radio.length > 0) {
		switch (stat_method_radio.val()) {
			case "1":
				num_die = 3;
				drop_die = 0;
				break;
			case "2":
				num_die = 4;
				drop_die = 1;
				break;
		}
	}
	var value = 1;
	if (radio.length > 0) {
		value = radio.val();
	}
	if (value == "D6") {
		value = randomRange(1,6);
	}
	if (test_distribution)
		value *= 10000;
	for (j=0; j<value; j++) {
		character.gender = randomRange(0,1);
		for (i=0; i<NUM_STATS; i++){
			stats[i] = getStat(num_die,drop_die);
		}
		character['stats'] = stats;
		character['class'] = possible_classes(stats);
		appendResult(character);
	}
	if (test_distribution)
		calc_dist();

}

$('#generate').button();

$('#generate').click( function() {
	generate();
	} );

function change_number(event) {
	var radio = $("#radioset input[type='radio']:checked");
	var count_text = "a hireling";
    if ( radio.length > 0 && radio.val() != "1") {
		count_text = radio.val() + " hirelings";
    }
	$('#generate > span').text("Generate " + count_text);

}
function change_min_stat(event) {
	var class_number = $(event.target).data('class');
	var stat_number = $(event.target).data('stat');
	classes[class_number].stats[stat_number] = event.target.value;
}

function change_weighting(event) {
	var class_number = $(event.target).data('class');
	classes[class_number].weighting = parseInt(event.target.value);
}

function onReady()
{
	var i, j, stat;
	var stat_div = $('#min_stats_div');
	for (i=0; i<classes.length; i++){
		var text = "<DIV class='class_stats' name='min_stat_"+classes[i].name+"'>";
		text += "<DIV class='class_title'>"+classes[i].name+"</DIV>";

		for (stat=0; stat<6; stat++) {
			text += "<DIV class='class_stat' name='min_stat_"+classes[i].name+'_'+stat+"'>";
			text += '<span class=stat_header>'+STAT_SHORT_NAMES[stat]+'</span>';
			text += '<select class="min_stat_select" data-class='+i+' data-stat='+stat+'>';
			for (j=0; j<=18; j++) {
				if (j!=1 && j!=2)
					if (classes[i].stats[stat] == j)
						text+='<option selected="selected">'+j+'</option>';
					else
						text+='<option>'+j+'</option>';
			}
			text+= '</select></DIV>';
		}
		text += "<DIV class='class_stat'><span class=stat_header>Weighting</span><input class='weight_input' size=3 data-class="+i+" value="+classes[i].weighting+"></input></DIV>";
		text += '</DIV>';
	    stat_div.append(text);

	}
	$('#name_credits').html(name_credits());
	$(".min_stat_select").change(change_min_stat);
	$(".weight_input").change(change_weighting);
	$("#radioset input[type='radio']").change(change_number);

/*
			  change: change_min_stat
			  }); */
}
$(document).ready(onReady);

</script>
</body>

